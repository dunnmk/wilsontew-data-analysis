---
title: "DSB-Monitoring CSV Summary Analysis (single collapsed_summary CSV)"
output:
  html_document:
    theme: bootstrap
    toc: true
    toc_depth: 3
---
***
1. Read the CSV (hard‑coded folder)

***
```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)

knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  fig.width = 11,
  fig.height = 6
)

# ---- User config ----
folder <- "C:/Users/dunnmk/Downloads/PD_Data/PD_Data"  # CHANGE THIS PATH
time_ref <- 0
time_cmp <- 180

# Plot toggles
trans_combos_to_plot <- c("A_to_D", "C_to_B")
show_extra_fc_plots <- FALSE
dsb_for_cis_correlation <- "DSB1"

# Optional filters (set any to NULL to include everything)
filters <- list(
  batch = NULL,
  time_point = NULL,
  DSB = NULL,
  combo = NULL
)

# ---- Small helpers ----
pct <- function(num, den) dplyr::if_else(den > 0, 100 * num / den, NA_real_)
fc_ratio <- function(num, den, eps = 1e-6) (num + eps) / (den + eps)

apply_filters <- function(df, filters = list()) {
  if (!is.null(filters$batch) && "batch" %in% names(df)) {
    df <- df %>% dplyr::filter(batch %in% filters$batch)
  }
  if (!is.null(filters$time_point) && "time_point" %in% names(df)) {
    df <- df %>% dplyr::filter(time_point %in% filters$time_point)
  }
  if (!is.null(filters$DSB) && "DSB" %in% names(df)) {
    df <- df %>% dplyr::filter(DSB %in% filters$DSB)
  }
  if (!is.null(filters$combo) && "combo" %in% names(df)) {
    df <- df %>% dplyr::filter(combo %in% filters$combo)
  }
  df
}

theme_allele_x <- function() {
  theme_bw() +
    theme(
      axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0.5, size = 8),
      plot.margin = margin(5.5, 15, 5.5, 5.5)
    )
}

stopifnot(dir.exists(folder))
```

```{r import-csv}
files <- list.files(folder, pattern = "_summary\\.csv$", full.names = TRUE)
stopifnot(length(files) > 0)

raw <- purrr::map_dfr(files, readr::read_csv, show_col_types = FALSE)

# Standardize time column name
if ("time" %in% names(raw) && !"time_point" %in% names(raw)) {
  raw <- raw %>% dplyr::rename(time_point = time)
}

raw <- raw %>% dplyr::mutate(time_point = as.numeric(time_point))

filtered <- apply_filters(raw, filters)

filtered |> head(10) |> knitr::kable(caption = "Combined CSV preview (after optional filters)")
```
***
2. Aggregate counts and percentages

Aggregate counts from DSB monitoring pulldown experiment

***
```{r aggregate-counts}
summarize_counts_pct <- function(df) {
  df %>%
    summarise(
      Total_Counts   = sum(count, na.rm = TRUE),
      Cis_Counts     = sum(count[cis_trans == "CIS"],   na.rm = TRUE),
      Trans_Counts   = sum(count[cis_trans == "TRANS"], na.rm = TRUE),
      A_to_B_Counts  = sum(count[combo == "A_to_B"], na.rm = TRUE),
      C_to_D_Counts  = sum(count[combo == "C_to_D"], na.rm = TRUE),
      A_to_D_Counts  = sum(count[combo == "A_to_D"], na.rm = TRUE),
      C_to_B_Counts  = sum(count[combo == "C_to_B"], na.rm = TRUE),
      Percent_Cis    = pct(Cis_Counts, Total_Counts),
      Percent_Trans  = pct(Trans_Counts, Total_Counts),
      Percent_A_to_B = pct(A_to_B_Counts, Total_Counts),
      Percent_C_to_D = pct(C_to_D_Counts, Total_Counts),
      Percent_A_to_D = pct(A_to_D_Counts, Total_Counts),
      Percent_C_to_B = pct(C_to_B_Counts, Total_Counts),
      .groups = "drop"
    )
}

agg_counts <- filtered %>%
  group_by(batch, time_point, DSB) %>%
  summarize_counts_pct()

agg_counts |> knitr::kable(caption = "Aggregated counts and percentages")

```

***
2.5. Batch-level QC plots (counts and CIS/TRANS composition)

These plots are intended to sanity-check overall depth and composition *before* allele-level cis/trans normalization.

```{r batch-qc-plots, message=FALSE}
# Re-use the same aggregation logic as the table above
agg_qc <- filtered %>%
  group_by(batch, time_point, DSB) %>%
  summarize_counts_pct() %>%
  ungroup()

# ---- 1) Total counts by batch ----
p_total_counts <- ggplot(agg_qc, aes(x = batch, y = Total_Counts, fill = DSB)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.75) +
  geom_text(
    aes(label = scales::comma(Total_Counts)),
    position = position_dodge(width = 0.8),
    vjust = -0.25,
    size = 2.7
  ) +
  facet_wrap(~ time_point, scales = "free_y") +
  theme_bw() +
  labs(
    title = "Total counts by batch (faceted by time)",
    x = "Batch",
    y = "Total counts"
  )

print(p_total_counts)

# ---- 2) Counts by category within each batch (split CIS-only vs TRANS-only) ----
cis_counts_long <- agg_qc %>%
  select(
    batch, time_point, DSB,
    Cis_Counts,
    A_to_B_Counts, C_to_D_Counts
  ) %>%
  pivot_longer(
    cols = -c(batch, time_point, DSB),
    names_to = "Metric",
    values_to = "Counts"
  ) %>%
  mutate(
    Metric = factor(
      Metric,
      levels = c("Cis_Counts", "A_to_B_Counts", "C_to_D_Counts"),
      labels = c("CIS (total)", "A→B (cis)", "C→D (cis)")
    )
  )

p_cis_counts_by_type <- ggplot(cis_counts_long, aes(x = batch, y = Counts, fill = Metric)) +
  geom_col(position = position_dodge(width = 0.85), width = 0.8) +
  geom_text(
    aes(label = scales::comma(Counts)),
    position = position_dodge(width = 0.85),
    vjust = -0.25,
    size = 2.4
  ) +
  facet_grid(time_point ~ DSB, scales = "free_y") +
  theme_bw() +
  labs(
    title = "CIS counts by category per batch",
    x = "Batch",
    y = "Counts",
    fill = ""
  )

print(p_cis_counts_by_type)

trans_counts_long <- agg_qc %>%
  select(
    batch, time_point, DSB,
    Trans_Counts,
    A_to_D_Counts, C_to_B_Counts
  ) %>%
  pivot_longer(
    cols = -c(batch, time_point, DSB),
    names_to = "Metric",
    values_to = "Counts"
  ) %>%
  mutate(
    Metric = factor(
      Metric,
      levels = c("Trans_Counts", "A_to_D_Counts", "C_to_B_Counts"),
      labels = c("TRANS (total)", "A→D (trans)", "C→B (trans)")
    )
  )

p_trans_counts_by_type <- ggplot(trans_counts_long, aes(x = batch, y = Counts, fill = Metric)) +
  geom_col(position = position_dodge(width = 0.85), width = 0.8) +
  geom_text(
    aes(label = scales::comma(Counts)),
    position = position_dodge(width = 0.85),
    vjust = -0.25,
    size = 2.4
  ) +
  facet_grid(time_point ~ DSB, scales = "free_y") +
  theme_bw() +
  labs(
    title = "TRANS counts by category per batch",
    x = "Batch",
    y = "Counts",
    fill = ""
  )

print(p_trans_counts_by_type)

# ---- 3) Percent CIS and Percent TRANS per group (split) ----
pct_cis_only <- agg_qc %>%
  select(batch, time_point, DSB, Percent_Cis) %>%
  mutate(Percent_Cis_Label = if_else(is.na(Percent_Cis), NA_character_, paste0(round(Percent_Cis, 1), "%")))

p_pct_cis <- ggplot(pct_cis_only, aes(x = batch, y = Percent_Cis, fill = DSB)) +
  geom_col(width = 0.75) +
  geom_text(aes(label = Percent_Cis_Label), vjust = -0.25, size = 2.6) +
  facet_wrap(~ time_point) +
  scale_y_continuous(limits = c(0, 100)) +
  theme_bw() +
  labs(
    title = "Percent CIS per group",
    x = "Batch",
    y = "Percent of total counts",
    fill = "DSB"
  )

print(p_pct_cis)

pct_trans_only <- agg_qc %>%
  select(batch, time_point, DSB, Percent_Trans) %>%
  mutate(Percent_Trans_Label = if_else(is.na(Percent_Trans), NA_character_, paste0(round(Percent_Trans, 1), "%")))

p_pct_trans <- ggplot(pct_trans_only, aes(x = batch, y = Percent_Trans, fill = DSB)) +
  geom_col(width = 0.75) +
  geom_text(aes(label = Percent_Trans_Label), vjust = -0.25, size = 2.6) +
  facet_wrap(~ time_point) +
  scale_y_continuous(limits = c(0, 100)) +
  theme_bw() +
  labs(
    title = "Percent TRANS per group",
    x = "Batch",
    y = "Percent of total counts",
    fill = "DSB"
  )

print(p_pct_trans)

# ---- 4) Within-CIS and within-TRANS combo composition (requested breakdowns) ----
agg_combo_within <- filtered %>%
  group_by(batch, time_point, DSB) %>%
  summarise(
    Cis_Counts   = sum(count[cis_trans == "CIS"], na.rm = TRUE),
    Trans_Counts = sum(count[cis_trans == "TRANS"], na.rm = TRUE),

    Cis_A_to_B_Counts = sum(count[cis_trans == "CIS" & combo == "A_to_B"], na.rm = TRUE),
    Cis_C_to_D_Counts = sum(count[cis_trans == "CIS" & combo == "C_to_D"], na.rm = TRUE),

    Trans_A_to_D_Counts = sum(count[cis_trans == "TRANS" & combo == "A_to_D"], na.rm = TRUE),
    Trans_C_to_B_Counts = sum(count[cis_trans == "TRANS" & combo == "C_to_B"], na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    Percent_A_to_B_in_Cis = pct(Cis_A_to_B_Counts, Cis_Counts),
    Percent_C_to_D_in_Cis = pct(Cis_C_to_D_Counts, Cis_Counts),
    Percent_Other_in_Cis   = pct(pmax(Cis_Counts - Cis_A_to_B_Counts - Cis_C_to_D_Counts, 0), Cis_Counts),
    Percent_A_to_D_in_Trans = pct(Trans_A_to_D_Counts, Trans_Counts),
    Percent_C_to_B_in_Trans = pct(Trans_C_to_B_Counts, Trans_Counts),
    Percent_Other_in_Trans   = pct(pmax(Trans_Counts - Trans_A_to_D_Counts - Trans_C_to_B_Counts, 0), Trans_Counts)
  )

cis_combo_long <- agg_combo_within %>%
  select(batch, time_point, DSB, Percent_A_to_B_in_Cis, Percent_C_to_D_in_Cis, Percent_Other_in_Cis) %>%
  pivot_longer(
    cols = c(Percent_A_to_B_in_Cis, Percent_C_to_D_in_Cis, Percent_Other_in_Cis),
    names_to = "Combo",
    values_to = "Percent"
  ) %>%
  mutate(
    Combo = recode(
      Combo,
      Percent_A_to_B_in_Cis = "A→B (within CIS)",
      Percent_C_to_D_in_Cis = "C→D (within CIS)",
      Percent_Other_in_Cis = "Other (within CIS)"
    )
  )

p_cis_combo_comp <- ggplot(cis_combo_long, aes(x = batch, y = Percent, fill = Combo)) +
  geom_col(width = 0.75) +
  geom_text(
    aes(label = if_else(is.na(Percent) | Percent <= 0, NA_character_, paste0(round(Percent, 1), "%"))),
    position = position_stack(vjust = 0.5),
    size = 2.4
  ) +
  facet_grid(time_point ~ DSB) +
  scale_y_continuous(limits = c(0, 100)) +
  theme_bw() +
  labs(
    title = "CIS composition: % A→B and % C→D (of CIS counts)",
    x = "Batch",
    y = "% of CIS counts",
    fill = ""
  )

print(p_cis_combo_comp)

trans_combo_long <- agg_combo_within %>%
  select(batch, time_point, DSB, Percent_A_to_D_in_Trans, Percent_C_to_B_in_Trans, Percent_Other_in_Trans) %>%
  pivot_longer(
    cols = c(Percent_A_to_D_in_Trans, Percent_C_to_B_in_Trans, Percent_Other_in_Trans),
    names_to = "Combo",
    values_to = "Percent"
  ) %>%
  mutate(
    Combo = recode(
      Combo,
      Percent_A_to_D_in_Trans = "A→D (within TRANS)",
      Percent_C_to_B_in_Trans = "C→B (within TRANS)",
      Percent_Other_in_Trans = "Other (within TRANS)"
    )
  )

p_trans_combo_comp <- ggplot(trans_combo_long, aes(x = batch, y = Percent, fill = Combo)) +
  geom_col(width = 0.75) +
  geom_text(
    aes(label = if_else(is.na(Percent) | Percent <= 0, NA_character_, paste0(round(Percent, 1), "%"))),
    position = position_stack(vjust = 0.5),
    size = 2.4
  ) +
  facet_grid(time_point ~ DSB) +
  scale_y_continuous(limits = c(0, 100)) +
  theme_bw() +
  labs(
    title = "TRANS composition: % A→D and % C→B (of TRANS counts)",
    x = "Batch",
    y = "% of TRANS counts",
    fill = ""
  )

print(p_trans_combo_comp)

```
***
3. Cis/trans normalization — per allele


***
```{r cis-trans-norm}
location_pct_by_allele <- function(df) {
  by_allele <- df %>%
    group_by(batch, time_point, DSB, allele) %>%
    summarise(
      Cis_Location_Counts   = sum(count[cis_trans == "CIS"],   na.rm = TRUE),
      Trans_Location_Counts = sum(count[cis_trans == "TRANS"], na.rm = TRUE),
      .groups = "drop"
    )

  totals <- by_allele %>%
    group_by(batch, time_point, DSB) %>%
    summarise(
      Total_Cis_Location_Counts   = sum(Cis_Location_Counts,   na.rm = TRUE),
      Total_Trans_Location_Counts = sum(Trans_Location_Counts, na.rm = TRUE),
      .groups = "drop"
    )

  by_allele %>%
    left_join(totals, by = c("batch", "time_point", "DSB")) %>%
    mutate(
      Percent_Location_in_Cis   = pct(Cis_Location_Counts, Total_Cis_Location_Counts),
      Percent_Location_in_Trans = pct(Trans_Location_Counts, Total_Trans_Location_Counts)
    )
}

dat_norm <- location_pct_by_allele(filtered)
dat_norm |> head(10) |> knitr::kable(caption = "Data after cis/trans normalization")

```
***
4. Allele frequency (CIS + TRANS)

***
```{r allele-freq}
allele_frequency <- function(df) {
  by_allele <- df %>%
    group_by(batch, time_point, DSB, allele) %>%
    summarise(
      Cis_Counts   = sum(count[cis_trans == "CIS"],   na.rm = TRUE),
      Trans_Counts = sum(count[cis_trans == "TRANS"], na.rm = TRUE),
      Allele_Total = Cis_Counts + Trans_Counts,
      .groups = "drop"
    )

  totals <- by_allele %>%
    group_by(batch, time_point, DSB) %>%
    summarise(
      Total_All = sum(Allele_Total, na.rm = TRUE),
      .groups = "drop"
    )

  by_allele %>%
    left_join(totals, by = c("batch", "time_point", "DSB")) %>%
    mutate(Allele_Frequency = dplyr::if_else(Total_All > 0, Allele_Total / Total_All, NA_real_))
}

dat_allele_freq <- allele_frequency(filtered)
dat_allele_freq |> head(10) |> knitr::kable(caption = "Allele frequencies")

```
***
5. Fold change calculations (time_cmp / time_ref)


***
```{r fold-change}
fold_change_table <- function(df_norm, value_col, time_ref, time_cmp) {
  df_norm %>%
    filter(time_point %in% c(time_ref, time_cmp)) %>%
    select(batch, time_point, DSB, allele, !!rlang::sym(value_col)) %>%
    pivot_wider(
      names_from = time_point,
      values_from = !!rlang::sym(value_col),
      values_fill = 0
    ) %>%
    mutate(
      FoldChange = fc_ratio(.data[[as.character(time_cmp)]], .data[[as.character(time_ref)]]),
      Log2FC = log2(FoldChange)
    )
}

dat_fc_cis <- fold_change_table(dat_norm, "Percent_Location_in_Cis", time_ref, time_cmp) %>%
  rename(
    FoldChange_Cis_vs_ref = FoldChange,
    Log2FC_Cis_vs_ref = Log2FC
  )

dat_fc_trans <- fold_change_table(dat_norm, "Percent_Location_in_Trans", time_ref, time_cmp) %>%
  rename(
    FoldChange_Trans_vs_ref = FoldChange,
    Log2FC_Trans_vs_ref = Log2FC
  )

```
***
6. CIS and TRANS bar plots

***
```{r CIS-bar-plot, message=FALSE}
plot_cis_percent <- function(dat_norm) {
  ggplot(dat_norm, aes(x = allele, y = Percent_Location_in_Cis)) +
    geom_col(width = 0.9, fill = "darkgreen") +
    geom_text(aes(label = round(Percent_Location_in_Cis, 1)),
              vjust = -0.3, size = 2.5, angle = 90) +
    facet_grid(time_point ~ batch + DSB, scales = "free_x") +
    theme_allele_x() +
    labs(title = "Percent in cis by allele", x = "Allele", y = "Percent in cis")
}

plot_cis_percent(dat_norm)

```

```{r trans-bar-plot, message=FALSE}
plot_trans_percent <- function(dat, combo_name) {
  df_plot <- dat %>%
    filter(combo == combo_name) %>%
    location_pct_by_allele() %>%
    select(batch, time_point, DSB, allele, Percent_Location_in_Trans)
  
  if (nrow(df_plot) > 0) {
    ggplot(df_plot, aes(x = allele, y = Percent_Location_in_Trans)) +
      geom_col(fill = "steelblue", width = 0.9) +
      geom_text(aes(label = round(Percent_Location_in_Trans, 1)),
                vjust = -0.3, size = 2.5, angle = 90) +
      facet_grid(time_point ~ batch + DSB, scales = "free_x") +
      theme_allele_x() +
      labs(
        title = paste("Percent in TRANS by allele:", combo_name),
        x = "Allele", y = "Percent in TRANS"
      )
  }
}

# TRANS plots for selected combos
for (cmb in trans_combos_to_plot) {
  p <- plot_trans_percent(filtered, cmb)
  if (!is.null(p)) print(p)
}

```

***
7. Fold change and allele frequency plots


***
```{r foldchange-bar-plot, message=FALSE}
plot_foldchange <- function(df, fc_col, title, fill) {
  ggplot(df, aes(x = allele, y = .data[[fc_col]])) +
    geom_col(width = 0.9, fill = fill) +
    geom_hline(yintercept = 2, linetype = "dotted", color = "red", size = 0.7) +
    geom_text(aes(label = round(.data[[fc_col]], 2)),
              vjust = -0.3, size = 2.5, angle = 90) +
    facet_grid(DSB ~ batch, scales = "free_x") +
    theme_allele_x() +
    labs(title = title, x = "Allele", y = "Fold change")
}

plot_allele_frequency <- function(dat_allele_freq) {
  ggplot(dat_allele_freq, aes(x = allele, y = Allele_Frequency)) +
    geom_col(width = 0.9, fill = "purple") +
    geom_text(aes(label = round(Allele_Frequency, 3)),
              vjust = -0.3, size = 2.5, angle = 90) +
    facet_grid(time_point ~ batch + DSB, scales = "free_x") +
    theme_allele_x() +
    labs(title = "Allele Frequency (CIS + TRANS)",
         x = "Allele", y = "Allele Frequency")
}

# Generate bar plots
plot_foldchange(
  dat_fc_cis,
  "FoldChange_Cis_vs_ref",
  paste0("Fold change (", time_cmp, "/", time_ref, ") CIS by allele"),
  "orange"
)
plot_foldchange(
  dat_fc_trans,
  "FoldChange_Trans_vs_ref",
  paste0("Fold change (", time_cmp, "/", time_ref, ") TRANS by allele"),
  "steelblue"
)
plot_allele_frequency(dat_allele_freq)

if (isTRUE(show_extra_fc_plots)) {
  p1 <- ggplot(dat_fc_cis, aes(x = allele, y = FoldChange_Cis_vs_ref, fill = DSB)) +
    geom_col(width = 0.9, position = "dodge") +
    geom_hline(yintercept = 2, linetype = "dotted", color = "red", size = 0.7) +
    geom_text(aes(label = round(FoldChange_Cis_vs_ref, 2)),
              position = position_dodge(width = 0.9),
              vjust = -0.3, size = 2.5, angle = 90) +
    facet_wrap(~ batch, scales = "free_x") +
    theme_allele_x() +
    labs(
      title = paste0("Fold change (", time_cmp, "/", time_ref, ") CIS by allele"),
      x = "Allele", y = "Fold change"
    )

  p2 <- ggplot(dat_fc_trans, aes(x = allele, y = FoldChange_Trans_vs_ref, fill = DSB)) +
    geom_col(width = 0.9, position = "dodge") +
    geom_hline(yintercept = 2, linetype = "dotted", color = "red", size = 0.7) +
    geom_text(aes(label = round(FoldChange_Trans_vs_ref, 2)),
              position = position_dodge(width = 0.9),
              vjust = -0.3, size = 2.5, angle = 90) +
    facet_wrap(~ batch, scales = "free_x") +
    theme_allele_x() +
    labs(
      title = paste0("Fold change (", time_cmp, "/", time_ref, ") TRANS by allele"),
      x = "Allele", y = "Fold change"
    )

  print(p1)
  print(p2)
}

```
***
8. Correlation: log2FC vs Allele Frequency


***
```{r cor-allele-log, message=FALSE}
library(ggrepel)

dat_wide <- dat_norm %>%
  filter(time_point %in% c(time_ref, time_cmp)) %>%
  select(batch, DSB, allele, time_point,
         Percent_Location_in_Cis, Percent_Location_in_Trans) %>%
  pivot_wider(
    names_from  = time_point,
    values_from = c(Percent_Location_in_Cis, Percent_Location_in_Trans),
    values_fill = 0
  ) %>%
  mutate(
    log2FC_CIS   = log2(fc_ratio(.data[[paste0("Percent_Location_in_Cis_", time_cmp)]],
                                .data[[paste0("Percent_Location_in_Cis_", time_ref)]])),
    log2FC_TRANS = log2(fc_ratio(.data[[paste0("Percent_Location_in_Trans_", time_cmp)]],
                                .data[[paste0("Percent_Location_in_Trans_", time_ref)]]))
  )

dat_fc_af <- dat_wide %>%
  inner_join(
    dat_allele_freq %>%
      filter(time_point == time_cmp) %>%
      select(batch, DSB, allele, Allele_Frequency),
    by = c("batch", "DSB", "allele")
  ) %>%
  filter(!is.na(Allele_Frequency) & Allele_Frequency > 0)

cor_summary <- dat_fc_af %>%
  group_by(batch, DSB) %>%
  summarise(
    cor_CIS_AF   = ifelse(n() >= 2, cor(log2FC_CIS, Allele_Frequency), NA),
    cor_TRANS_AF = ifelse(n() >= 2, cor(log2FC_TRANS, Allele_Frequency), NA),
    n_obs = n(),
    .groups = "drop"
  )

knitr::kable(cor_summary, caption = "Correlation: log2FC vs Allele Frequency")

```
```{r cor-scatter-plots, message=FALSE}
plot_correlation_cis <- function(dat_fc_af, batch_name, dsb_name = dsb_for_cis_correlation) {
  df_batch <- dat_fc_af %>% filter(batch == batch_name, DSB == dsb_name)
  if (nrow(df_batch) < 2) return(NULL)
  
  ggplot(df_batch, aes(x = Allele_Frequency, y = log2FC_CIS, label = allele)) +
    geom_point(size = 3, alpha = 0.8, color = "darkgreen") +
    geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
    geom_smooth(method = "lm", se = FALSE, color = "red") +
    geom_text_repel(size = 3, max.overlaps = 20) +
    theme_bw() +
    labs(
      title = paste0("Log2FC CIS vs Allele Freq | Batch: ", batch_name, " | ", dsb_name),
      x = "Allele Frequency", y = "log2FC CIS"
    )
}

plot_correlation_trans <- function(dat_fc_af, batch_name) {
  df_batch <- dat_fc_af %>% filter(batch == batch_name)
  if (nrow(df_batch) < 2) return(NULL)
  
  ggplot(df_batch, aes(x = Allele_Frequency, y = log2FC_TRANS, color = DSB, label = allele)) +
    geom_point(size = 3, alpha = 0.8) +
    geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
    geom_smooth(method = "lm", se = FALSE) +
    geom_text_repel(size = 3, max.overlaps = 20) +
    theme_bw() +
    labs(
      title = paste0("Log2FC TRANS vs Allele Freq | Batch: ", batch_name),
      x = "Allele Frequency", y = "log2FC TRANS"
    )
}

unique_batches <- unique(dat_fc_af$batch)

for (b in unique_batches) {
  p_cis   <- plot_correlation_cis(dat_fc_af, b)
  p_trans <- plot_correlation_trans(dat_fc_af, b)
  
  if (!is.null(p_cis))   print(p_cis)
  if (!is.null(p_trans)) print(p_trans)
}

```


